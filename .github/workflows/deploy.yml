name: CI/CD Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      # - name: ğŸ§ª Setup Node.js 20
      #   uses: actions/setup-node@v3
      #   with:
      #     node-version: '20'

      # - name: ğŸ“¦ Install dependencies
      #   run: npm ci

      # - name: ğŸ”§ Install Playwright browsers
      #   run: npx playwright install --with-deps

      # - name: ğŸš€ Run E2E tests
      #   run: echo "Brak testÃ³w - pomijam krok"

      - name: ğŸ“¦ Archive app for deploy
        run: |
          mkdir archive
          tar --exclude='node_modules' --exclude='archive' -czf archive/app.tar.gz .
          mv archive/app.tar.gz .

      - name: ğŸ” Copy archive to VPS via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.PRIVATE_KEY }}
          source: "app.tar.gz"
          target: "~/actions"

      - name: ğŸš€ Deploy on VPS via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.PRIVATE_KEY }}
          script: |

            # Przygotuj katalog
            mkdir -p ~/app
            tar -xzf ~/actions/app.tar.gz -C ~/app
            cd ~/app

            # Zwolnij miejsce: usuÅ„ obrazy starsze niÅ¼ 24h
            echo "ğŸ§¹ Prune unused images older than 24h"
            docker image prune -a --filter "until=24h" || true

            # Buduj nowy obraz
            echo "ğŸ³ Building Docker image my-app"
            docker build -t my-app . || { echo "âŒ Build failed"; exit 1; }

            # Zatrzymaj i usuÅ„ stary kontener
            echo "ğŸ›‘ Stopping old container my-app-container"
            docker stop next-container 2>/dev/null || true
            echo "ğŸ—‘ï¸ Removing old container my-app-container"
            docker rm next-container 2>/dev/null || true

            # Uruchom nowy kontener
            echo "ğŸš€ Running new container my-app-container on port 20201"
            docker run -d \
              --name my-app-container \
              -p 20201:3000 \
              my-app

             
            # UsuÅ„ zawartoÅ›Ä‡ /app
            rm -rf ~/app/*