name: CI/CD Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repo
        uses: actions/checkout@v3

      - name: ðŸ§ª Setup Node.js 20
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ”§ Install Playwright browsers
        run: npx playwright install --with-deps

      - name: ðŸš€ Run E2E tests
        run: npm run test:e2e

      - name: ðŸ“¦ Archive app for deploy
        run: |
          tar --exclude='node_modules' -czf app.tar.gz .

      - name: ðŸ” Copy archive to VPS via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.PRIVATE_KEY }}
          source: "app.tar.gz"
          target: "~/deploy"

      - name: ðŸš€ Deploy on VPS via SSH
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          port: ${{ secrets.VPS_PORT }}
          key: ${{ secrets.PRIVATE_KEY }}
          script: |

            # Przygotuj katalog
            mkdir -p ~/app
            tar -xzf ~/deploy/app.tar.gz -C ~/app
            cd ~/app

            # Zwolnij miejsce: usuÅ„ obrazy starsze niÅ¼ 24h
            echo "ðŸ§¹ Prune unused images older than 24h"
            docker image prune -a --filter "until=24h" || true

            # Buduj nowy obraz
            echo "ðŸ³ Building Docker image my-app"
            docker build -t my-app . || { echo "âŒ Build failed"; exit 1; }

            # Zatrzymaj i usuÅ„ stary kontener
            echo "ðŸ›‘ Stopping old container my-app-container"
            docker stop my-app-container 2>/dev/null || true
            echo "ðŸ—‘ï¸ Removing old container my-app-container"
            docker rm my-app-container 2>/dev/null || true

            # Uruchom nowy kontener
            echo "ðŸš€ Running new container my-app-container on port 20201"
            docker run -d \
              --name my-app-container \
              -p 20201:3000 \
              my-app